<!DOCTYPE html>
<html>
  <head>
    <title>Audio Call Demo</title>
  </head>
  <body>
    <h1>Audio Call Demo</h1>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script>
      const socket = io();
      const roomId = "myroom";
      const peers = {};

      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        socket.emit("join-room", roomId);

        socket.on("user-connected", (id) => {
          const peer = new SimplePeer({
            initiator: true,
            trickle: false,
            stream,
            config: {
              iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
            },
          });

          peer.on("signal", (signal) =>
            socket.emit("signal", { to: id, signal })
          );
          peer.on("stream", (remoteStream) => {
            const audio = document.createElement("audio");
            audio.srcObject = remoteStream;
            audio.autoplay = true;
            document.body.appendChild(audio);
          });

          peers[id] = peer;
        });

        socket.on("signal", (data) => {
          if (!peers[data.from]) {
            const peer = new SimplePeer({
              initiator: false,
              trickle: false,
              stream,
              config: {
                iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
              },
            });

            peer.on("signal", (signal) =>
              socket.emit("signal", { to: data.from, signal })
            );
            peer.on("stream", (remoteStream) => {
              const audio = document.createElement("audio");
              audio.srcObject = remoteStream;
              audio.autoplay = true;
              document.body.appendChild(audio);
            });

            peers[data.from] = peer;
          }
          peers[data.from].signal(data.signal);
        });

        socket.on("user-disconnected", (id) => {
          if (peers[id]) peers[id].destroy();
        });
      });
    </script>
  </body>
</html>
